#!/usr/bin/env bash

set -euo pipefail

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Script directory
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"
cd "$PROJECT_ROOT"

# Build configuration
BINARY_NAME="multiedit"
VERSION="${VERSION:-$(git describe --tags --always --dirty 2>/dev/null || echo "dev")}"
BUILD_TIME="$(date -u +%Y-%m-%dT%H:%M:%SZ)"
GIT_COMMIT="$(git rev-parse --short HEAD 2>/dev/null || echo "unknown")"

# Parse command line arguments
VERBOSE=false
CLEAN=false
INSTALL=false
TARGET_OS="${GOOS:-$(go env GOOS)}"
TARGET_ARCH="${GOARCH:-$(go env GOARCH)}"

usage() {
    cat << EOF
Usage: bin/build [OPTIONS]

Build the multiedit binary with optimizations and metadata.

OPTIONS:
    -v, --verbose       Verbose output
    -c, --clean         Clean before building
    -i, --install       Install to \$GOPATH/bin after building
    -o, --os OS         Target OS (default: current)
    -a, --arch ARCH     Target architecture (default: current)
    -h, --help          Show this help message

EXAMPLES:
    bin/build                    # Build for current platform
    bin/build --clean            # Clean and build
    bin/build --install          # Build and install to \$GOPATH/bin
    bin/build -o linux -a amd64  # Cross-compile for Linux AMD64

EOF
    exit 0
}

# Parse arguments
while [[ $# -gt 0 ]]; do
    case $1 in
        -v|--verbose)
            VERBOSE=true
            shift
            ;;
        -c|--clean)
            CLEAN=true
            shift
            ;;
        -i|--install)
            INSTALL=true
            shift
            ;;
        -o|--os)
            TARGET_OS="$2"
            shift 2
            ;;
        -a|--arch)
            TARGET_ARCH="$2"
            shift 2
            ;;
        -h|--help)
            usage
            ;;
        *)
            echo -e "${RED}Error: Unknown option $1${NC}"
            usage
            ;;
    esac
done

log_info() {
    echo -e "${BLUE}==>${NC} $1"
}

log_success() {
    echo -e "${GREEN}✓${NC} $1"
}

log_error() {
    echo -e "${RED}✗${NC} $1"
}

log_warn() {
    echo -e "${YELLOW}!${NC} $1"
}

# Clean build artifacts
if [ "$CLEAN" = true ]; then
    log_info "Cleaning build artifacts..."
    rm -f "$BINARY_NAME"
    rm -rf dist/
    log_success "Clean complete"
fi

# Show build info
log_info "Building multiedit"
echo "  Version:      $VERSION"
echo "  Git Commit:   $GIT_COMMIT"
echo "  Build Time:   $BUILD_TIME"
echo "  Target OS:    $TARGET_OS"
echo "  Target Arch:  $TARGET_ARCH"
echo ""

# Run tests first
log_info "Running tests..."
if [ "$VERBOSE" = true ]; then
    go test -v ./...
else
    go test ./...
fi
log_success "All tests passed"

# Check for common issues
log_info "Running go vet..."
go vet ./...
log_success "go vet passed"

log_info "Checking for formatting issues..."
if ! gofmt -l . | grep -q .; then
    log_success "Code is properly formatted"
else
    log_warn "Some files need formatting (run: gofmt -w .)"
fi

# Build flags
LDFLAGS="-s -w"
LDFLAGS="$LDFLAGS -X main.version=$VERSION"
LDFLAGS="$LDFLAGS -X main.buildTime=$BUILD_TIME"
LDFLAGS="$LDFLAGS -X main.gitCommit=$GIT_COMMIT"

# Determine output binary name
OUTPUT_BINARY="$BINARY_NAME"
if [ "$TARGET_OS" != "$(go env GOOS)" ] || [ "$TARGET_ARCH" != "$(go env GOARCH)" ]; then
    OUTPUT_BINARY="${BINARY_NAME}-${TARGET_OS}-${TARGET_ARCH}"
fi
if [ "$TARGET_OS" = "windows" ]; then
    OUTPUT_BINARY="${OUTPUT_BINARY}.exe"
fi

# Build
log_info "Building binary..."
BUILD_CMD="go build -ldflags=\"$LDFLAGS\" -o \"$OUTPUT_BINARY\" ."

if [ "$VERBOSE" = true ]; then
    echo "  Command: $BUILD_CMD"
fi

GOOS="$TARGET_OS" GOARCH="$TARGET_ARCH" eval "$BUILD_CMD"

# Check if build was successful
if [ -f "$OUTPUT_BINARY" ]; then
    BINARY_SIZE=$(du -h "$OUTPUT_BINARY" | cut -f1)
    log_success "Build complete: $OUTPUT_BINARY ($BINARY_SIZE)"
else
    log_error "Build failed"
    exit 1
fi

# Install if requested
if [ "$INSTALL" = true ]; then
    log_info "Installing to \$GOPATH/bin..."
    GOBIN="${GOBIN:-$(go env GOPATH)/bin}"
    mkdir -p "$GOBIN"
    cp "$OUTPUT_BINARY" "$GOBIN/$BINARY_NAME"
    log_success "Installed to $GOBIN/$BINARY_NAME"
fi

# Show binary info
log_info "Binary information:"
file "$OUTPUT_BINARY" 2>/dev/null || true
echo ""

# Verify it runs
if [ "$TARGET_OS" = "$(go env GOOS)" ] && [ "$TARGET_ARCH" = "$(go env GOARCH)" ]; then
    log_info "Verifying binary..."
    if "./$OUTPUT_BINARY" --version >/dev/null 2>&1; then
        log_success "Binary verification passed"
        echo ""
        "./$OUTPUT_BINARY" --version
    else
        log_warn "Binary verification failed (might be expected for cross-compiled binaries)"
    fi
fi

echo ""
log_success "Build completed successfully!"
